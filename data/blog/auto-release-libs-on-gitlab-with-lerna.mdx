---
title: ä½¿ç”¨ Lerna åœ¨ Gitlab ä¸­å®ç°è‡ªåŠ¨åŒ–ç®¡ç†
date: 2022-05-16
draft: false
tags: ['Lerna', 'Gitlab', 'Monorepo', 'CI/CD']
summary: åˆ©ç”¨ Gitlab çš„ CI/CD é…åˆ Lerna å®ç°è‡ªåŠ¨ç”Ÿæˆ CHANGELOGã€æ›´æ–°ç›¸å…³ä¾èµ–ä»¥åŠå‘å¸ƒç‰ˆæœ¬
---

## èƒŒæ™¯

æœ€è¿‘åœ¨åšæŠ½åº“ç›¸å…³çš„å·¥ä½œï¼Œä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œé€‰ç”¨äº† Monorepo çš„æ–¹å¼è¿›è¡Œç»„ç»‡ï¼ŒæŠ€æœ¯ä¸Šä½¿ç”¨äº† [Lerna](https://lerna.js.org/) å’Œ [Yarn](https://classic.yarnpkg.com/lang/en/)ï¼Œ`Lerna` æ¥å¤„ç†å‘å¸ƒé—®é¢˜ï¼Œ`Yarn` æ¥å¤„ç†ä¾èµ–é—®é¢˜ã€‚

Github æä¾›äº†å¤§é‡çš„ Actionsï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®Œæˆå‘ç‰ˆæµç¨‹è‡ªåŠ¨åŒ–ã€‚ä½†åœ¨ Gitlab ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±ç¼–æ’ CI/CD æ¥å®ç°ä¸€äº›è‡ªåŠ¨åŒ–çš„åŠŸèƒ½ã€‚

åŸæœ¬å‘åŒ…éƒ½æ˜¯åœ¨æœ¬åœ°æ‰‹åŠ¨å‘ç‰ˆæˆ–è€…åœ¨ä»£ç åˆå¹¶è¿›å…¥ `master` åï¼ˆåŒ…å« CHANGELOGï¼‰æ‰§è¡Œ CI/CD åŠè‡ªåŠ¨å‘ç‰ˆã€‚è¿™æ¬¡æŠ½åº“æƒ³å®Œå–„ä¸€ä¸‹åŸºç¡€è®¾æ–½ï¼Œè®©å‘åŒ…è‡ªåŠ¨åŒ–ã€‚å¼€å‘åªéœ€å…³æ³¨ä»£ç æœ¬èº«ä»¥åŠåšå¥½ commitï¼ˆä¼šæ ¹æ® commit ä¿¡æ¯ç”Ÿæˆ CHANGELOGï¼‰ï¼Œå‰©ä¸‹çš„éƒ½æœ‰å·¥å…·è‡ªåŠ¨å®Œæˆã€‚

## å®ç°è¿‡ç¨‹

ä¸€å¼€å§‹æœŸæœ›çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

1. ç¼–å†™åŠŸèƒ½ä»£ç 
2. æäº¤ **Merge Request** è¿›è¡Œ Code Review
3. åˆå¹¶åˆ° `master` è§¦å‘ CI/CD è‡ªåŠ¨ç”Ÿæˆ CHANGELOGã€æ›´æ–°ç›¸å…³ä¾èµ–ä»¥åŠå‘å¸ƒç‰ˆæœ¬

éƒ¨åˆ† `package.json` å†…å®¹å¦‚ä¸‹ï¼š

```json:package.json {6-10}
{
  "name": "example-libs",
  "private": true,
  "workspaces": ["packages/*"],
  "scripts": {
    "bump_version": "yarn run build && lerna version --conventional-commits --create-release gitlab --yes",
    "release": "yarn run build && lerna publish from-git --yes && yarn run deploy",
    "link-all": "yarn run build && yarn unlink-all; lerna exec --parallel yarn link",
    "unlink-all": "lerna exec --no-bail --parallel yarn unlink"
  }
}
```

- `bump_version`ï¼šè‡ªåŠ¨æ ¹æ® commit æ›´æ–°ç‰ˆæœ¬å·å¹¶ç”Ÿæˆ CHANGELOGï¼ŒåŒæ—¶ä¼šåœ¨ Gitlab ä¸­åˆ›å»ºä¸€ä¸ª release
- `release`ï¼šå‘å¸ƒå½“å‰ commit æ‰“ tag çš„åŒ…ï¼ˆå°±æ˜¯ `bump_version` ç”Ÿæˆçš„ï¼‰
- `link-all` å’Œ `unlink-all`ï¼šæ–¹ä¾¿æœ¬åœ° link è°ƒè¯•çš„è„šæœ¬

å› ä¸º `bump_version` åœ¨å½“å‰åˆ†æ”¯ commit å¹¶ push ä»£ç ï¼Œæ‰€ä»¥å¯¼è‡´äº†ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š

1. éœ€è¦æ‰“å¼€ `master` åˆ†æ”¯ **Allowed to push** çš„è®¾ç½®
2. CI/CD ç¯å¢ƒæ²¡æœ‰ push ä»£ç çš„æƒé™
3. è‡ªåŠ¨æäº¤çš„ commit ä¹Ÿä¼šè§¦å‘ CI/CD å¯¼è‡´æ­»å¾ªç¯

### é—®é¢˜ä¸€

åœ¨å¤šäººåä½œçš„ç¯å¢ƒä¸‹ï¼Œä»£ç éƒ½éœ€è¦æäº¤å…ˆ **Merge Request**ï¼ŒCode Review æ²¡é—®é¢˜åæ‰èƒ½åˆå…¥ `master`ã€‚æ‰€ä»¥ï¼Œå…è®¸ç›´æ¥ push ä¸å¤ªåˆé€‚ï¼Œå®¹æ˜“äº§ç”Ÿè¯¯æ“ä½œã€‚åŒæ—¶ï¼Œä¸‡ä¸€è‡ªåŠ¨åŒ–è„šæœ¬å‡ºé—®é¢˜äº†ä¹Ÿä¸å®¹æ˜“åŠæ—¶å‘ç°å¤„ç†ã€‚

å› æ­¤ï¼Œæ”¹è¿›åçš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç¼–å†™åŠŸèƒ½ä»£ç 
2. æäº¤ **Merge Request** è¿›è¡Œ Code Review
3. Code Review é€šè¿‡ååœ¨å½“å‰åˆ†æ”¯è§¦å‘ CI/CD è‡ªåŠ¨ç”Ÿæˆ CHANGELOG å¹¶æ›´æ–°ç›¸å…³ä¾èµ–
4. æ£€æŸ¥è‡ªåŠ¨ç”Ÿæˆçš„å†…å®¹æ˜¯å¦æ­£ç¡®å¹¶åˆå…¥ `master`
5. åœ¨ `master` è‡ªåŠ¨è§¦å‘ CI/CD å‘å¸ƒç‰ˆæœ¬

è¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰å†…å®¹éƒ½åœ¨å…¶ä»–åˆ†æ”¯ä¸Šå®Œæˆã€‚ç¡®è®¤æ— è¯¯åï¼Œåªéœ€åˆå…¥ `master`ï¼ŒCI/CD ä¾¿èƒ½æ ¹æ®æœ€æ–°å†…å®¹å®Œæˆå‘ç‰ˆçš„æ“ä½œäº†ã€‚

### é—®é¢˜äºŒ

Gitlab ä¸ºäº† CI/CD çš„æ‰§è¡Œé€Ÿåº¦ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ `git fetch` çš„æ–¹å¼è·å–ä»£ç ï¼Œæ²¡æœ‰ `origin` ä¿¡æ¯ã€‚åŒæ—¶ï¼ŒCI/CD çš„ç¯å¢ƒä¹Ÿæ²¡æœ‰ç™»å½•è´¦å·ã€‚è¿™ä¸¤ç‚¹å¯¼è‡´äº†æ— æ³•åœ¨ CI/CD ç¯å¢ƒä¸­ push ä»£ç ï¼Œå¥½åœ¨ Gitlab æä¾›äº† token çš„æ–¹å¼è¿›è¡Œè®¤è¯ï¼Œå®ç°æ–¹å¼å¦‚ä¸‹ï¼š

```yaml:.gitlab-ci.yml {14}
stages:
  - merge_check
  - bump_version
  - release

bump_version:
  stage: bump_version
  image: node:16
  before_script:
    - yarn install
  only:
    - merge_requests
  script:
    - git config --global credential.helper store
    - git remote set-url origin "https://gitlab-ci-token:$GL_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git"
    - git fetch origin
    - git checkout "$CI_COMMIT_REF_NAME"
    - git config --global user.email "bot@example.com"
    - git config --global user.name "RELEASE BOT"
    - yarn bump_version
```

é‡ç‚¹åœ¨äºä¸Šé¢è¢«é«˜äº®çš„è¿™è¡Œä»£ç ï¼Œå…¶ä¸­ `$GL_TOKEN` æ˜¯ä¸ªäººç”Ÿæˆçš„ `Access Tokens` å¹¶éœ€è¦é…ç½®åœ¨ CI/CD ç¯å¢ƒå˜é‡å½“ä¸­ã€‚å…¶ä½™çš„ç¯å¢ƒå˜é‡éƒ½æ˜¯å†…ç½®çš„ï¼Œç”¨äºæŒ‡å®šé¡¹ç›®åœ°å€ä»¥åŠåˆ†æ”¯åã€‚

### é—®é¢˜ä¸‰

CI/CD ä¸­ `merge_check` æ˜¯ç”¨æ¥æ£€æµ‹ Code Review çš„ç‚¹èµæ•°çš„ï¼Œä½†ç‚¹èµæ•°è¾¾æ ‡åè¯¥ Job æ‰ä¼šæˆåŠŸã€‚å½“ `merge_check` é€šè¿‡åå°†è‡ªåŠ¨æ‰§è¡Œ `bump_version`ï¼Œè€Œ `bump_version` ä¼šåœ¨å½“å‰åˆ†æ”¯äº§ç”Ÿæ–°çš„ commitï¼Œå°±åˆä¼šè§¦å‘æ–°çš„ CI/CD å¯¼è‡´æ— é™å¾ªç¯ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦ CI/CD å¿½ç•¥ `bump_version` çš„ commit å°±è¡Œã€‚

```yaml:.gitlab-ci.yml {13-15}
stages:
  - merge_check
  - bump_version
  - release

bump_version:
  stage: bump_version
  image: node:16
  before_script:
    - yarn install
  only:
    - merge_requests
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /^chore:\spublish/
  script:
    - git config --global credential.helper store
    - git remote set-url origin "https://gitlab-ci-token:$GL_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git"
    - git fetch origin
    - git checkout "$CI_COMMIT_REF_NAME"
    - git config --global user.email "bot@example.com"
    - git config --global user.name "RELEASE BOT"
    - yarn bump_version
```

å› ä¸ºå…¬å¸ Gitlab ç‰ˆæœ¬è¾ƒä½ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡åŒ¹é… commit message çš„æ–¹å¼å®ç°çš„ã€‚åœ¨ Gitlab 13.11 åŠä»¥åï¼Œæ”¯æŒäº†ç¯å¢ƒå˜é‡ `$CI_COMMIT_AUTHOR`ï¼Œå¯ä»¥é€šè¿‡ commit æäº¤çš„ä½œè€…è¿›è¡ŒåŒ¹é…ã€‚

## æ€»ç»“

è‡³æ­¤ï¼Œæ•´å¥—æµç¨‹å·²ç»è·‘é€šäº†ã€‚æˆ‘ä»¬å˜å¯ä»¥ä¸“æ³¨äºå†™ä»£ç ï¼Œåªéœ€ç»´æŠ¤å¥½ commit ä¿¡æ¯ï¼Œå‰©ä¸‹ç¹çé‡å¤çš„ä¸€åˆ‡å°±äº¤ç»™ CI/CD å§ï¼ä»æ­¤æˆ‘å†ä¹Ÿä¸ä¼šå¿˜è®°æ›´æ–° CHANGELOG å’Œå¿˜è®°å‘å¸ƒç‰ˆæœ¬äº†ã€‚ğŸ˜›

å½“ç„¶ï¼Œè¿™å¥—æµç¨‹ä»ç„¶æœ‰å¾ˆå¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¯”å¦‚ï¼š

- ç¼“å­˜ `node_modules` ç›®å½•
- å¤ç”¨ `build` åçš„äº§ç‰©
- æ”¯æŒ `canary` ç‰ˆæœ¬å‘å¸ƒ
- ......

æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±ç ”ç©¶ä¸€ä¸‹å¦‚ä½•å®ç°ã€‚
